// Job Interview Simulator - System Flowchart
// Generated from actual codebase
// Use with: dot -Tpng flowchart.dot -o flowchart.png

digraph JobInterviewSimulator {
    rankdir=TB;
    node [shape=box, style=rounded];
    
    // User interaction
    Start [label="User Starts\nConversation", shape=ellipse, style=filled, fillcolor=lightblue]
    UserMsg [label="User sends\nChatMessage", shape=box]
    UserAnswer [label="User Provides\nAnswer", shape=box]
    UserSelects [label="User Selects\nAvatar", shape=box]
    
    // Interviewer Agent
    InterviewerAgent [label="Interviewer Agent\n(Session Management)", shape=box, style=filled, fillcolor=lightcyan]
    ACK [label="Send\nChatAcknowledgement", shape=box]
    CheckRole [label="Role Set?", shape=diamond]
    AutoRole [label="Auto-set Role:\nJunior Data Analyst", shape=box]
    CheckPersona [label="Persona\nSelected?", shape=diamond]
    ShowAvatars [label="Display Avatar Options:\nHR, Junior Dev,\nSenior Dev, Corporate Exec", shape=box]
    StorePersona [label="Store Persona\nSelection", shape=box]
    StoreAnswer [label="Store Answer\nin Session", shape=box]
    AddToHistory [label="Add Q&A to\nconversation_history", shape=box]
    MarkFinished [label="Mark Interview\nFinished", shape=box]
    WaitMsg [label="Send: Generating\nreport...", shape=box]
    GenReport [label="Generate Final Report:\n- Average scores\n- Per-question breakdown\n- Strengths & Improvements\n- Next steps", shape=box, style=filled, fillcolor=lightyellow]
    SendReport [label="Send Final Report\nto User", shape=box]
    End [label="Interview\nComplete", shape=ellipse, style=filled, fillcolor=lightgreen]
    
    // Knowledge Graph
    QueryKG1 [label="Query InterviewKG:\nget_focus_skills()", shape=box, style=filled, fillcolor=lightgreen]
    QueryKG2 [label="Query InterviewKG:\nget_topics_for_persona()\nget_focus_skills()", shape=box, style=filled, fillcolor=lightgreen]
    KG1 [label="MeTTa Knowledge Graph\nReturns Focus Skills", shape=box, style=filled, fillcolor=palegreen]
    KG2 [label="MeTTa Knowledge Graph\nReturns Topics & Skills", shape=box, style=filled, fillcolor=palegreen]
    
    // Question Generation
    GenFirstQ [label="Generate First Question\nvia ASI Cloud API\n(With KG context)", shape=box, style=filled, fillcolor=plum]
    GenNextQ [label="Generate Next Adaptive Question\nvia ASI Cloud API\n(Uses conversation_history + KG)", shape=box, style=filled, fillcolor=plum]
    SendQ1 [label="Send First Question\nto User", shape=box]
    SendNextQ [label="Send Next Question\nto User", shape=box]
    CheckDone [label="All 5 Questions\nAnswered?", shape=diamond]
    
    // Evaluation
    SendEvalReq [label="Send EvaluationRequest\nto Evaluator Agent\n(ASYNC/Non-blocking)", shape=box, style=filled, fillcolor=wheat]
    EvalAgent [label="Evaluator Agent", shape=box, style=filled, fillcolor=lightyellow]
    CallLLM [label="Call ASI Cloud API\nto Evaluate Answer", shape=box, style=filled, fillcolor=plum]
    EvalScores [label="Calculate Scores:\nClarity, Specificity,\nConfidence, Overall", shape=box]
    BuildResponse [label="Build EvaluationResponse\nwith scores, feedback,\nimproved answer", shape=box]
    StoreEval [label="Store Evaluation Silently\n(No user feedback)", shape=box]
    CheckFinished [label="Interview\nFinished?", shape=diamond]
    CheckAllEvals [label="All Evaluations\nReceived?", shape=diamond]
    
    // Flow connections
    Start -> UserMsg
    UserMsg -> InterviewerAgent
    InterviewerAgent -> ACK
    ACK -> CheckRole
    
    CheckRole ->|No| AutoRole
    CheckRole ->|Yes| CheckPersona
    AutoRole -> CheckPersona
    
    CheckPersona ->|No| ShowAvatars
    ShowAvatars -> UserSelects
    UserSelects -> StorePersona
    StorePersona -> QueryKG1
    
    QueryKG1 -> KG1
    KG1 -> GenFirstQ
    GenFirstQ -> SendQ1
    SendQ1 -> UserAnswer
    
    CheckPersona ->|Yes| UserAnswer
    UserAnswer -> StoreAnswer
    StoreAnswer -> AddToHistory
    AddToHistory -> SendEvalReq
    
    SendEvalReq -> QueryKG2
    QueryKG2 -> KG2
    KG2 -> GenNextQ
    GenNextQ -> CheckDone
    
    CheckDone ->|No| SendNextQ
    SendNextQ -> UserAnswer
    CheckDone ->|Yes| MarkFinished
    MarkFinished -> WaitMsg
    WaitMsg -> CheckAllEvals
    
    SendEvalReq -> EvalAgent [style=dashed, label="async"]
    EvalAgent -> CallLLM
    CallLLM -> EvalScores
    EvalScores -> BuildResponse
    BuildResponse -> StoreEval [style=dashed, label="async response"]
    StoreEval -> CheckFinished
    
    CheckFinished ->|Yes| CheckAllEvals
    CheckFinished ->|No| SendNextQ
    
    CheckAllEvals ->|Yes| GenReport
    CheckAllEvals ->|No| StoreEval
    GenReport -> SendReport
    SendReport -> End
    
    // Styling
    {rank=same; InterviewerAgent, EvalAgent}
    {rank=same; QueryKG1, QueryKG2}
    {rank=same; GenFirstQ, GenNextQ, CallLLM}
}

